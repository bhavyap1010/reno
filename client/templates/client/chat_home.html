{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="{% static 'client/chat.css' %}">
</head>

<body>
    <div class="chat-layout">
        <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
        <!-- Sidebar -->
        <div class="chat-sidebar" id="chatSidebar">
            <h3>Your Conversations</h3>
            <ul>
                {% for room, other_user in rooms_with_users %}
                <li><a href="{% url 'chat-home' room.room_name %}">{{ other_user.username|title }}</a></li>
                {% endfor %}
            </ul>
        </div>

        <!-- Chat Panel -->
        <div class="chat-main">
            {% if room_name %}
            <div class="title_header">
                <div class="header-left">
                    <h2>{{ other_user|title }}</h2>
                </div>
                <div class="header-logo">
                    <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                        <!-- Grid pattern centered -->
                        <rect x="10" y="10" width="8" height="8" fill="#1e293b" rx="1" />
                        <rect x="22" y="10" width="8" height="8" fill="#64748b" rx="1" />
                        <rect x="10" y="22" width="8" height="8" fill="#64748b" rx="1" />
                        <rect x="22" y="22" width="8" height="8" fill="#1e293b" rx="1" />
                    </svg>
                </div>
            </div>

            <div class="chat__item__container" id="id_chat_item_container">
                {% for message in messages %}
                {% if not message.deleted %}
                <div
                    class="chat-message {% if message.sender.username == request.user.username %}self{% else %}other{% endif %}"
                    data-message-id="{{ message.id }}">
                    {% if message.sender.username != request.user.username %}
                    <strong>{{ message.sender.username }}</strong>: {{ message.content }}
                    {% else %}
                    {{ message.content }} <strong>{{ message.sender.username }}</strong>
                    <button class="delete-message-btn" data-message-id="{{ message.id }}" style="margin-left:8px; background:none; border:none; color:#888; cursor:pointer;" title="Delete">&times;</button>
                    {% endif %}
                </div>
                {% endif %}
                {% endfor %}
            </div>
            <div class="chat-input-container">
                <input type="text" id="id_message_send_input" placeholder="Type your message..." />
                <button type="submit" id="id_message_send_button">Send</button>
            </div>

            <script>
                const roomName = "{{ room_name }}";
                const chatSocket = new WebSocket("ws://" + window.location.host + "/chat/" + roomName + "/");

                chatSocket.onopen = () => console.log("Connected to WebSocket");
                chatSocket.onclose = () => console.log("Disconnected");

                document.querySelector("#id_message_send_input").focus();
                document.querySelector("#id_message_send_input").onkeyup = function (e) {
                    if (e.keyCode == 13) document.querySelector("#id_message_send_button").click();
                };

                document.querySelector("#id_message_send_button").onclick = function () {
                    const messageInput = document.querySelector("#id_message_send_input");
                    const message = messageInput.value;
                    if (!message.trim()) return;
                    const currentTime = new Date().toLocaleTimeString();

                    chatSocket.send(JSON.stringify({
                        message: message,
                        username: "{{ request.user.username }}",
                        time: currentTime
                    }));
                };

                chatSocket.onmessage = function (e) {
                    const data = JSON.parse(e.data);
                    const container = document.querySelector("#id_chat_item_container");
                    if (data.action === "delete") {
                        // Remove the message div
                        const msgDiv = container.querySelector(`[data-message-id='${data.message_id}']`);
                        if (msgDiv) msgDiv.remove();
                        return;
                    }
                    // Add new message
                    const div = document.createElement("div");
                    div.className = `chat-message ${data.username === "{{ request.user.username }}" ? "self" : "other"}`;
                    div.setAttribute("data-message-id", data.message_id);
                    if (data.username === "{{ request.user.username }}") {
                        div.innerHTML = `${data.message} <strong>${data.username}</strong> <button class="delete-message-btn" data-message-id="${data.message_id}" style="margin-left:8px; background:none; border:none; color:#888; cursor:pointer;" title="Delete">&times;</button>`;
                    } else {
                        div.innerHTML = `<strong>${data.username}</strong>: ${data.message}`;
                    }
                    container.appendChild(div);
                    container.scrollTop = container.scrollHeight;
                    document.querySelector("#id_message_send_input").value = "";
                };

                // Delegate delete button click
                document.getElementById("id_chat_item_container").addEventListener("click", function (e) {
                    if (e.target.classList.contains("delete-message-btn")) {
                        const messageId = e.target.getAttribute("data-message-id");
                        // Send delete action via websocket
                        chatSocket.send(JSON.stringify({
                            action: "delete",
                            message_id: messageId
                        }));
                        // Optionally, also send to backend for audit/logging
                        fetch("{% url 'delete-message' %}", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": "{{ csrf_token }}"
                            },
                            body: JSON.stringify({ message_id: messageId })
                        });
                    }
                });

                const sidebarToggle = document.getElementById("sidebarToggle");
                const chatSidebar = document.getElementById("chatSidebar");

                sidebarToggle.addEventListener("click", () => {
                    chatSidebar.classList.toggle("active");
                });
            </script>
            {% else %}
            <div class="empty-chat-state">
                <div class="empty-chat-icon">ðŸ’¬</div>
                <h3>Select a chat to start messaging</h3>
                <p>Choose a conversation from the sidebar to begin chatting.</p>
            </div>
            {% endif %}
        </div>
    </div>
</body>

</html>
{% endblock %}