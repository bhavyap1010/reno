{% extends 'client/base.html' %}

{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'client/home.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- Header -->
<div class="header">
    <div class="header-left">
        <div class="logo">Reno</div>

        <form class="search-bar" action="{% url 'home' %}" method="get">
            <input type="text" name="q" placeholder="Search" value="{{ request.GET.q }}">
            <button type="submit">Search</button>
        </form>

        <div class="filter-wrapper">
            <button class="icon-button" onclick="toggleFilterModal()" title="Filter">
                <i class="fa-solid fa-filter"></i>
            </button>

            <div id="filterModal">
                <form method="get" action="{% url 'home' %}">
                    {% if request.GET.q %}
                        <input type="hidden" name="q" value="{{ request.GET.q }}">
                    {% endif %}
                    {% for service in available_services %}
                        <label>
                            <input type="checkbox" name="services" value="{{ service }}">
                            {{ service|capfirst }}
                        </label>
                    {% endfor %}
                    <br>
                    <button type="submit">Apply</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings Icon -->
    <button class="icon-button" title="Settings" onclick="toggleSidebar()">
        <i class="fa-solid fa-cog"></i>
    </button>
</div>

<div id="sidebarOverlay" class="sidebar-overlay">
    <div class="sidebar">
        <button class="close-btn" onclick="toggleSidebar()">&times;</button>

        <form method="get" action="{% url 'chat-home' %}">
            <button type="submit" class="sidebar-btn">View Messages</button>
        </form>

        {% if user.profile.account_type == 'business' %}
        <form method="get" action="{% url 'business-profile' %}">
            <button type="submit" class="sidebar-btn">Create/Edit Profile</button>
        </form>
        {% endif %}

        <form method="get" action="{% url 'request-service' %}">
            <button type="submit" class="sidebar-btn">Request Service</button>
        </form>

        <form method="post" action="{% url 'logout-user' %}" class="logout-form">
            {% csrf_token %}
            <button type="submit" class="logout-btn">Logout</button>
        </form>
    </div>
</div>

<h2>Businesses</h2>
<div class="scroll-container">
    {% for business in businesses %}
    <div class="card">
        <h3><a href="{% url 'business-detail' business.id %}">{{ business.name }}</a></h3>
        <p><strong>Services:</strong> {{ business.services }}</p>
        <p><strong>Location:</strong> {{ business.service_location }}</p>
        <p>
            <strong>Status:</strong>
            {% if business.status == 'available' %}
                <span style="color:green;">Available</span>
            {% else %}
                <span style="color:red;">Busy</span>
            {% endif %}
        </p>
        <a href="{% url 'write-review' business.id %}" class="card-button">Write a Review</a>
    </div>
    {% empty %}
    <div>No businesses available.</div>
    {% endfor %}
</div>

<h2>Service Requests</h2>
<div class="scroll-container">
    {% for request in service_requests %}
    <div class="card">
        <h3>{{ request.title }}</h3>
        <p><strong>Needed Services:</strong> {{ request.services_needed }}</p>
        <p><strong>Location:</strong> {{ request.location }}</p>
        <p><strong>Description:</strong> {{ request.description|truncatechars:100 }}</p>
        <p><strong>Created By:</strong> {{ request.user.username }}</p>
        <div style="display: flex; gap: 8px;">
            <a href="{% url 'service-request-detail' request.id %}" class="card-button" style="flex:1; text-align:center;">View</a>
            {% if request.user != user %}
            <button class="card-button" onclick="startChat('{{ request.user.username }}')">Start Chat</button>
            {% endif %}
            {% if request.user == user %}
            <form method="post" action="{% url 'delete-service-request' request.id %}">
                {% csrf_token %}
                <button type="submit" class="card-button delete">Delete</button>
            </form>
            {% endif %}
        </div>
    </div>
    {% empty %}
    <div>No service requests found.</div>
    {% endfor %}
</div>

{{ available_services|json_script:"available-services-data" }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const availableServices = JSON.parse(document.getElementById('available-services-data').textContent);
    // ...existing code...
});
</script>

<script>
    function toggleSidebar() {
        const overlay = document.getElementById("sidebarOverlay");
        overlay.style.display = overlay.style.display === "block" ? "none" : "block";
    }

    document.addEventListener("click", function (e) {
        const overlay = document.getElementById("sidebarOverlay");
        const sidebar = document.querySelector(".sidebar");
        const settingsBtn = document.querySelector('.fa-cog');
        if (overlay.style.display === "block" &&
            !sidebar.contains(e.target) &&
            !settingsBtn.contains(e.target)) {
            overlay.style.display = "none";
        }
    });

    function toggleFilterModal() {
        const modal = document.getElementById("filterModal");
        modal.style.display = modal.style.display === "block" ? "none" : "block";
    }

    // Close modal when clicking outside
    document.addEventListener('click', function(event) {
        const modal = document.getElementById("filterModal");
        const filterBtn = document.querySelector('.fa-filter');
        if (!modal.contains(event.target) && !filterBtn.contains(event.target)) {
            modal.style.display = 'none';
        }
    });

    function startChat(otherUser) {
        fetch("{% url 'chat-start' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ other_user: otherUser })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.room_name) {
                const chatHomeUrl = "{% url 'chat-home' 'room_name_placeholder' %}".replace('room_name_placeholder', data.room_name);
                window.location.href = chatHomeUrl;
            } else {
                throw new Error("Invalid response format");
            }
        })
        .catch(error => {
            console.error("Error starting chat:", error);
            alert("Failed to start chat. Please try again.");
        });
    }
</script>
{% endblock %}