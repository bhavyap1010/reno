{% extends 'client/base.html' %}

{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'client/home.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- Header -->
<div class="header">
    <div class="header-left">
        <div class="logo">Reno</div>

        <form class="search-bar" action="{% url 'home' %}" method="get">
            <input type="text" name="q" placeholder="Search" value="{{ request.GET.q }}">
            <button type="submit">Search</button>
        </form>

        <div class="filter-wrapper">
            <button class="icon-button" onclick="toggleFilterModal()" title="Filter">
                <i class="fa-solid fa-filter"></i>
            </button>

            <div id="filterModal">
                <form method="get" action="{% url 'home' %}">
                    {% if request.GET.q %}
                        <input type="hidden" name="q" value="{{ request.GET.q }}">
                    {% endif %}
                    <label><input type="checkbox" name="services" value="cleaning"> Cleaning</label>
                    <label><input type="checkbox" name="services" value="plumbing"> Plumbing</label>
                    <label><input type="checkbox" name="services" value="electrical"> Electrical</label>
                    <label><input type="checkbox" name="services" value="landscaping"> Landscaping</label>
                    <label><input type="checkbox" name="services" value="delivery"> Delivery</label>
                    <br>
                    <button type="submit">Apply</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings Icon -->
    <button class="icon-button" title="Settings">
        <i class="fa-solid fa-cog"></i>
    </button>
</div>

<h1>Dashboard</h1>

<form action="{% url 'logout-user' %}" method="post">
    {% csrf_token %}
    <button type="submit">Logout</button>
</form>

{% if user.profile.account_type == 'business' %}
<form action="{% url 'business-profile' %}" method="get">
    <button type="submit">Create Business Listing</button>
</form>
{% endif %}

<form action="{% url 'request-service' %}" method="get">
    <button type="submit">Request a Service</button>
</form>

<form action="{% url 'chat-home' %}" method="get">
    <button type="submit">View Messages</button>
</form>

<h2>Businesses</h2>
<ul>
    {% for business in businesses %}
    <li>
        <strong>
            <a href="{% url 'business-detail' business.id %}">
                {{ business.name }}
            </a>
        </strong><br>
        Services: {{ business.services }}<br>
        Location: {{ business.service_location }}<br>
        <a href="{% url 'write-review' business.id %}">Review</a>
    </li>
    {% empty %}
    <li>No businesses available.</li>
    {% endfor %}
</ul>

<h2>Service Requests</h2>
<ul>
    {% for request in service_requests %}
    <li>
        <strong>{{ request.title }}</strong><br>
        Needed Services: {{ request.services_needed }}<br>
        Location: {{ request.location }}<br>
        Description: {{ request.description }} <br>
        Created By: {{ request.user.username }} <br>
        {% if request.user != user %}
        <a href="javascript:void(0);" onclick="startChat('{{ request.user.username }}')">Start Chat</a>
        {% endif %}
    </li>
    {% empty %}
    <li>No service requests found.</li>
    {% endfor %}
</ul>

<script>
    function toggleFilterModal() {
        const modal = document.getElementById("filterModal");
        modal.style.display = modal.style.display === "block" ? "none" : "block";
    }

    // Close modal when clicking outside
    document.addEventListener('click', function(event) {
        const modal = document.getElementById("filterModal");
        const filterBtn = document.querySelector('.fa-filter');
        if (!modal.contains(event.target) && !filterBtn.contains(event.target)) {
            modal.style.display = 'none';
        }
    });

    function startChat(otherUser) {
        fetch("{% url 'chat-start' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ other_user: otherUser })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.room_name) {
                const chatHomeUrl = "{% url 'chat-home' 'room_name_placeholder' %}".replace('room_name_placeholder', data.room_name);
                window.location.href = chatHomeUrl;
            } else {
                throw new Error("Invalid response format");
            }
        })
        .catch(error => {
            console.error("Error starting chat:", error);
            alert("Failed to start chat. Please try again.");
        });
    }
</script>
{% endblock %}