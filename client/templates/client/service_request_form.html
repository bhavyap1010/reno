{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Request a Service</title>
  <link rel="stylesheet" href="{% static 'client/root.css' %}">
  <link rel="stylesheet" href="{% static 'client/auth.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <h1 id="auth_title">Reno</h1>
  <div class="form_wrapper">
    <div class="title_container">
      <h2>Request a Service</h2>
    </div>

    <form method="post" enctype="multipart/form-data" id="serviceRequestForm">
      {% csrf_token %}

      <div class="input_field">
        <span><i class="fas fa-heading"></i></span>
        {{ form.title }}
      </div>

      <div class="input_field">
        <label for="service-search">Needed Services</label>
        <input type="text" id="service-search" placeholder="Type to search services..." autocomplete="off" style="width:200px;">
        <div id="service-suggestions" style="border:1px solid #ccc; background:#fff; position:absolute; z-index:10; display:none; max-height:120px; overflow-y:auto;"></div>
        <div id="selected-services" style="margin:8px 0;"></div>
        <!-- Hidden inputs for selected services will be appended here -->
        {% if form.services_needed.errors %}
          <div class="form_error">
            {% for error in form.services_needed.errors %}
              <p>{{ error }}</p>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="input_field">
        <span><i class="fas fa-location-dot"></i></span>
        {{ form.location }}
      </div>

      <div class="input_field textarea_field">
        <span><i class="fas fa-align-left"></i></span>
        {{ form.description }}
      </div>

      <div class="input_field">
        <span><i class="fas fa-image"></i></span>
        <input type="file" name="images" required multiple accept="image/*">
        <div style="font-size:12px;color:#888;">You can upload up to 5 images.</div>
      </div>

      <input type="submit" value="Submit Request">
    </form>
    <div class="link_container" style="text-align:center; margin-top:10px;">
      <a href="{% url 'home' %}" class="register-button">Return Home</a>
    </div>
  </div>
  {{ available_services|json_script:"available-services-data" }}
  {{ selected_services|json_script:"selected-services-data" }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const availableServices = JSON.parse(document.getElementById('available-services-data').textContent);
      let initialSelected = [];
      const selectedData = document.getElementById('selected-services-data');
      if (selectedData) {
        initialSelected = JSON.parse(selectedData.textContent);
      }
      const selectedServices = new Set(initialSelected);

      const serviceInput = document.getElementById('service-search');
      const suggestionsBox = document.getElementById('service-suggestions');
      const selectedBox = document.getElementById('selected-services');
      const form = document.getElementById('serviceRequestForm');

      function renderSelectedServices() {
        selectedBox.innerHTML = '';
        // Remove old hidden inputs
        form.querySelectorAll('input[name="services_needed"]').forEach(e => e.remove());
        selectedServices.forEach(service => {
          // Tag
          const tag = document.createElement('span');
          tag.style.cssText = 'display:inline-block;background:#e0e7ff;color:#1e40af;border-radius:12px;padding:2px 10px;margin:2px 4px 2px 0;font-size:0.95em;';
          tag.textContent = service.charAt(0).toUpperCase() + service.slice(1);
          // Remove button
          const remove = document.createElement('span');
          remove.style.cssText = 'margin-left:6px;color:#888;cursor:pointer;font-weight:bold;';
          remove.textContent = 'Ã—';
          remove.onclick = () => {
            selectedServices.delete(service);
            renderSelectedServices();
          };
          tag.appendChild(remove);
          selectedBox.appendChild(tag);
          // Hidden input
          const hidden = document.createElement('input');
          hidden.type = 'hidden';
          hidden.name = 'services_needed';
          hidden.value = service;
          form.appendChild(hidden);
        });
      }
      renderSelectedServices();

      if (serviceInput) {
        serviceInput.addEventListener('input', function() {
          const val = this.value.trim().toLowerCase();
          suggestionsBox.innerHTML = '';
          if (!val) {
            suggestionsBox.style.display = 'none';
            return;
          }
          const matches = availableServices.filter(s => s.toLowerCase().includes(val) && !selectedServices.has(s));
          if (matches.length === 0) {
            suggestionsBox.style.display = 'none';
            return;
          }
          matches.forEach(service => {
            const item = document.createElement('div');
            item.style.cssText = 'padding:4px 8px;cursor:pointer;';
            item.textContent = service.charAt(0).toUpperCase() + service.slice(1);
            item.onclick = () => {
              selectedServices.add(service);
              renderSelectedServices();
              serviceInput.value = '';
              suggestionsBox.style.display = 'none';
            };
            suggestionsBox.appendChild(item);
          });
          suggestionsBox.style.display = 'block';
        });

        serviceInput.addEventListener('blur', function() {
          setTimeout(() => { suggestionsBox.style.display = 'none'; }, 100);
        });

        serviceInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            const first = suggestionsBox.querySelector('div');
            if (first) first.click();
          }
        });
      }
    });
  </script>
</body>
</html>